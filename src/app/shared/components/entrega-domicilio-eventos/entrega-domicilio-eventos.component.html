<app-header [isModal]="true" title="Pago"></app-header>

<ion-content [fullscreen]="true">
  <!-- Método de Pago -->
  <ion-card class="payment-card">
    <ion-card-header>
      <h2 class="title">Método de Pago</h2>
    </ion-card-header>
    <ion-card-content>
      <ion-radio-group (ionChange)="onPaymentChange($event.detail.value)">
        <ion-card class="option-card" button (click)="onPaymentChange('efectivo')" [class.selected]="selectedPayment === 'efectivo'">
          <ion-item>
            <ion-icon name="cash-outline" slot="start" class="option-icon"></ion-icon>
            <ion-label>Efectivo en domicilio</ion-label>
            <ion-radio slot="end" value="efectivo"></ion-radio>
          </ion-item>
        </ion-card>
        <ion-card class="option-card" button (click)="onPaymentChange('paypal')" [class.selected]="selectedPayment === 'paypal'">
          <ion-item>
            <ion-icon name="card-outline" slot="start" class="option-icon"></ion-icon>
            <ion-label>Tarjeta</ion-label>
            <ion-radio slot="end" value="tarjeta"></ion-radio>
          </ion-item>
        </ion-card>
      </ion-radio-group>
    </ion-card-content>
  </ion-card>

  <!-- Resumen de Compra -->
  <ion-card class="summary-card">
    <ion-card-header>
      <h3 class="summary-title">Resumen de compra</h3>
    </ion-card-header>
    <ion-card-content>
      <div class="summary-item">
        <span>Productos ({{ cart?.detalle_carrito?.length || 0 }})</span>
        <span>{{ cart?.total | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</span>
      </div>
      <div *ngFor="let item of cart?.detalle_carrito" class="summary-item">
        <span>{{ item.producto?.nombre || '' }} x{{ item.cantidad }}</span>
        <span>{{ item.subtotal | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</span>
      </div>
      <div class="divider"></div>
      
      <!-- Subtotal with discount if applicable -->
      <div class="summary-item" *ngIf="discountAmount > 0">
        <span class="original-price">Subtotal: </span>
        <span class="original-price">{{ cart?.total | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</span>
      </div>
      <div class="summary-item" *ngIf="discountAmount > 0">
        <span class="descuento">Descuento: </span>
        <span class="descuento">-{{porcentaje | number:'1.0-0' }}%</span>
      </div>
      <div class="summary-item" *ngIf="discountAmount > 0">
        <span class="discounted-price">Subtotal con descuento:</span>
        <span class="discounted-price">{{ cart?.total- (cart?.total*(porcentaje/100)) | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</span>
      </div>
      <div class="summary-item" *ngIf="discountAmount === 0">
        <span>Subtotal:</span>
        <span>{{ cart?.total | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</span>
      </div>

      <!-- Peso actual y mensaje de envío -->
      <div class="summary-item">
        <span>Peso total:</span>
        <span>{{ totalWeight }}kg</span>
      </div>
      <div *ngIf="isEligibleForFreeDelivery()" class="free-shipping-message">
        <ion-icon name="gift-outline" color="success"></ion-icon>
        <span class="success-text">¡Tienes envío gratis por eventos!</span>
      </div>
      <div *ngIf="!isEligibleForFreeDelivery()" class="delivery-fee-message">
        <ion-icon name="information-circle-outline" color="warning"></ion-icon>
        <span class="warning-text">
          Agrega {{ getRemainingWeightForFreeDelivery() }}kg más para envío gratis (mínimo {{ MINIMUM_WEIGHT_FOR_FREE_DELIVERY }}kg)
        </span>
      </div>

      <!-- Costo de envío fijo para eventos -->
      <div class="summary-item" *ngIf="!isEligibleForFreeDelivery()">
        <span>Costo de envío:</span>
        <span>{{ DELIVERY_FEE_EVENTOS | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</span>
      </div>

      <div class="divider"></div>
      
      <!-- Final total -->
      <div class="summary-item total-item">
        <span><strong>Total a pagar:</strong></span>
        <span>
          <strong>{{ getTotalAmount() | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }} MXN</strong>
        </span>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Botón Confirmar Pago tarjeta-->
  <div *ngIf="selectedPayment === 'tarjeta'" class="confirm-button-container-paypal">
    <!-- entrega-negocio.page.html -->
    <div id="paypal-button-container"></div>

  </div>

  <!-- Botón Confirmar Pago -->
  <div *ngIf="selectedPayment === 'efectivo'" class="confirm-button-container">
    <ion-button 
      expand="block" 
      mode="ios"
      [class.animated]="confirming" 
      [disabled]="confirming || paymentConfirmed"
      (click)="confirmPayment()">
      <ion-icon *ngIf="paymentConfirmed" name="checkmark-outline" slot="start"></ion-icon>
      {{ paymentConfirmed ? 'Pedido Confirmado' : 'Confirmar Pago' }}
    </ion-button>
  </div>    
</ion-content>
