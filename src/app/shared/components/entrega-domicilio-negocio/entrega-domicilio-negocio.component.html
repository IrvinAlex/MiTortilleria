<app-header [isModal]="true" title="Pago"></app-header>

<ion-content [fullscreen]="true">
  <!-- Método de Pago -->
  <ion-card class="payment-card">
    <ion-card-header>
      <h2 class="title">Método de Pago</h2>
    </ion-card-header>
    <ion-card-content>
      <ion-radio-group (ionChange)="onPaymentChange($event.detail.value)">
        <ion-card class="option-card" button (click)="onPaymentChange('efectivo')" [class.selected]="selectedPayment === 'efectivo'">
          <ion-item>
            <ion-icon name="cash-outline" slot="start" class="option-icon"></ion-icon>
            <ion-label>Efectivo en domicilio</ion-label>
            <ion-radio slot="end" value="efectivo"></ion-radio>
          </ion-item>
        </ion-card>
        <ion-card class="option-card" button (click)="onPaymentChange('paypal')" [class.selected]="selectedPayment === 'paypal'">
          <ion-item>
            <ion-icon name="card-outline" slot="start" class="option-icon"></ion-icon>
            <ion-label>Tarjeta</ion-label>
            <ion-radio slot="end" value="tarjeta"></ion-radio>
          </ion-item>
        </ion-card>
      </ion-radio-group>
    </ion-card-content>
  </ion-card>

  <!-- Resumen de Compra -->
  <ion-card class="summary-card">
    <ion-card-header>
      <h3 class="summary-title">Resumen de compra</h3>
    </ion-card-header>
    <ion-card-content>
      <div class="summary-item">
        <span>Productos ({{ cart?.detalle_carrito?.length || 0 }})</span>
        <span>{{ cart?.total | currency }}</span>
      </div>
      <div *ngFor="let item of cart?.detalle_carrito" class="summary-item">
        <span>{{ item.producto?.nombre || '' }} x{{ item.cantidad }}</span>
        <span>{{ item.subtotal | currency }}</span>
      </div>
      <div class="divider"></div>
      
      <!-- Subtotal with discount if applicable -->
      <div class="summary-item" *ngIf="discountAmount > 0">
        <span class="original-price">Subtotal: </span>
        <span class="original-price">{{ cart?.total | currency }}</span>
      </div>
      <div class="summary-item" *ngIf="discountAmount > 0">
        <span class="descuento">Descuento: </span>
        <span class="descuento">-{{porcentaje | number:'1.0-0' }}%</span>
      </div>
      <div class="summary-item" *ngIf="discountAmount > 0">
        <span class="discounted-price">Subtotal con descuento:</span>
        <span class="discounted-price">{{ cart?.total- (cart?.total*(porcentaje/100)) | currency }}</span>
      </div>
      <div class="summary-item" *ngIf="discountAmount === 0">
        <span>Subtotal:</span>
        <span>{{ cart?.total | currency }}</span>
      </div>

      <!-- Free shipping message -->
      <div *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) >= 140" class="free-shipping-message">
        <ion-icon name="gift-outline" color="success"></ion-icon>
        <span class="success-text">¡Tienes envío gratis!</span>
      </div>

      <!-- Transport fee -->
      <div class="summary-item">
        <span>Tarifa de transporte ({{ distanciaKm }} km):</span>
        <span *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) >= 140">{{ 0 | currency }}</span>
        <span *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) < 140">{{ transportFee | currency }}</span>
      </div>

      <!-- Service charge -->
      <div class="summary-item" *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) < 140">
        <span>Cargo de servicio:</span>
        <span>{{ 5 | currency }}</span>
      </div>

      <!-- Motivational message for orders under $140 -->
      <div *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) < 140" class="motivational-message">
        <ion-icon name="information-circle-outline" color="primary"></ion-icon>
        <span class="info-text">Agrega {{ 140 - (cart?.total - (cart?.total * (porcentaje / 100))) | currency }} más para envío gratis</span>
      </div>

      <div class="divider"></div>
      
      <!-- Final total -->
      <div class="summary-item total-item">
        <span><strong>Total a pagar:</strong></span>
        <span *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) >= 140">
          <strong>{{ cart?.total - (cart?.total * (porcentaje / 100)) | currency }}</strong>
        </span>
        <span *ngIf="(cart?.total - (cart?.total * (porcentaje / 100))) < 140">
          <strong>{{ cart?.total - (cart?.total * (porcentaje / 100)) + transportFee + 5 | currency }}</strong>
        </span>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Botón Confirmar Pago tarjeta-->
  <div *ngIf="selectedPayment === 'tarjeta'" class="confirm-button-container-paypal">
    <!-- entrega-negocio.page.html -->
    <div id="paypal-button-container"></div>

  </div>

  <!-- Botón Confirmar Pago -->
  <div *ngIf="selectedPayment === 'efectivo'" class="confirm-button-container">
    <ion-button 
      expand="block" 
      mode="ios"
      [class.animated]="confirming" 
      [disabled]="confirming || paymentConfirmed"
      (click)="confirmPayment()">
      <ion-icon *ngIf="paymentConfirmed" name="checkmark-outline" slot="start"></ion-icon>
      {{ paymentConfirmed ? 'Pedido Confirmado' : 'Confirmar Pago' }}
    </ion-button>
  </div>
</ion-content>
