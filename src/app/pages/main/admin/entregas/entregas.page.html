<app-header [showMenu]="true" title="Entregas"></app-header>
<ion-content>
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Search bar -->
  <ion-searchbar 
    mode="ios" 
    animated="true" 
    placeholder="Buscar por cliente, productos o código..." 
    [(ngModel)]="searchTerm" 
    (ionInput)="filterPedidos()">
  </ion-searchbar>

  <!-- QR Scanner button -->
  <ion-button 
    expand="block" 
    fill="solid" 
    class="action-button" 
    (click)="escanear()">
    <ion-icon class="scan-icon" slot="start" name="qr-code-outline"></ion-icon>
    Escanear código QR
  </ion-button>

  <!-- Orders grid -->
  <div class="orders-grid" *ngIf="pedidosFiltrados.length > 0">
    <div class="order-card" *ngFor="let pedido of pedidosFiltrados">
      <!-- Order header with price and status -->
      <div class="order-header">
        <div class="price-section">
          <div class="currency-symbol">MXN</div>
          <div class="price-amount">{{ (pedido.total || 0) | currency:'MXN':'symbol-narrow':'1.2-2':'en-US' }}</div>
          <div class="price-label">Total del pedido</div>
        </div>
        <div class="status-badge">
          <ion-icon [name]="getStatusIcon(pedido.estatus)" [color]="getColorIcon(pedido.estatus)"></ion-icon>
          {{ getDisplayStatus(pedido) }}
        </div>
      </div>

      <!-- Customer section -->
      <div class="customer-section">
        <div class="customer-name">
          <ion-icon name="person-circle-outline"></ion-icon>
          {{ pedido.nombre_cliente }}
        </div>
      </div>

      <!-- Information grid -->
      <div class="info-grid">
        <!-- Delivery type -->
        <div class="info-item">
          <ion-icon 
            class="info-icon" 
            [name]="getDeliveryTypeIcon(getEffectiveDeliveryType(pedido))"
            [color]="getDeliveryTypeColor(getEffectiveDeliveryType(pedido))">
          </ion-icon>
          <div class="info-content">
            <div class="info-label">Tipo de entrega</div>
            <div class="info-value">
              {{ getEffectiveDeliveryType(pedido) === 'negocio' ? 'Recolección en negocio' : 'Entrega a domicilio' }}
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div class="info-item">
          <ion-icon 
            class="info-icon" 
            [name]="getEffectiveDeliveryType(pedido) === 'negocio' ? 'time-outline' : 'truck-outline'">
          </ion-icon>
          <div class="info-content">
            <div class="info-label">{{ getScheduledLabel(pedido) }}</div>
            <div class="info-value info-highlight">
              {{ getScheduledDate(pedido) | date: 'dd/MM/yyyy HH:mm' }}
            </div>
          </div>
        </div>

        <!-- Address or pickup location -->
        <div class="info-item" *ngIf="getEffectiveDeliveryType(pedido) === 'domicilio'">
          <ion-icon class="info-icon" name="location-outline"></ion-icon>
          <div class="info-content">
            <div class="info-label">Dirección de entrega</div>
            <div class="info-value">
              {{ getDisplayAddress(pedido) || 'Entrega a domicilio' }}
            </div>
          </div>
        </div>

        <!-- Special instructions -->
        <div class="info-item" *ngIf="getDisplayInstructions(pedido)">
          <ion-icon class="info-icon" name="chatbubble-outline"></ion-icon>
          <div class="info-content">
            <div class="info-label">Instrucciones especiales</div>
            <div class="info-value">
              {{ getDisplayInstructions(pedido) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Tags -->
      <div class="tags-section">
        <div class="tag">
          <ion-icon name="card-outline"></ion-icon>
          {{ pedido.tipo_pago }}
        </div>
        <div class="tag">
          <ion-icon [name]="getDeliveryTypeIcon(getEffectiveDeliveryType(pedido))"></ion-icon>
          {{ getEffectiveDeliveryType(pedido) === 'negocio' ? 'Negocio' : 'Domicilio' }}
        </div>
      </div>

      <!-- Action buttons -->
      <div class="actions-section">
        <ion-button 
          class="action-btn primary" 
          fill="solid" 
          (click)="openAsignarEntrega(pedido)">
          <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
          Entregar
        </ion-button>
        <ion-button 
          class="action-btn secondary" 
          fill="outline" 
          (click)="cancelarPedido(pedido)"
          *ngIf="pedido.estatus.toLowerCase() !== 'cancelado' && pedido.estatus.toLowerCase() !== 'entregado'">
          <ion-icon slot="start" name="close-circle-outline"></ion-icon>
          Cancelar
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Loading state -->
  <div class="orders-grid" *ngIf="loading">
    <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5,6]">
      <div class="skeleton-header">
        <ion-skeleton-text animated style="width: 30%; height: 60px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 25%; height: 32px;"></ion-skeleton-text>
      </div>
      <div class="skeleton-item">
        <ion-skeleton-text animated style="width: 60%; height: 24px;"></ion-skeleton-text>
      </div>
      <div class="skeleton-item">
        <ion-skeleton-text animated style="width: 80%; height: 16px;"></ion-skeleton-text>
      </div>
      <div class="skeleton-item">
        <ion-skeleton-text animated style="width: 70%; height: 16px;"></ion-skeleton-text>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!loading && !pedidosFiltrados.length">
    <ion-icon class="empty-icon" name="receipt-outline"></ion-icon>
    <div class="empty-title">No hay pedidos disponibles</div>
    <div class="empty-subtitle">Los nuevos pedidos aparecerán aquí automáticamente</div>
  </div>
</ion-content>



