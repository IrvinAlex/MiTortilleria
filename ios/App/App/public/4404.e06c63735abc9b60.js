"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4404],{4404:(W,C,d)=>{d.r(C),d.d(C,{EntregasPageModule:()=>X});var _=d(177),x=d(9417),c=d(5933),T=d(8265),p=d(467),t=d(4438),F=d(8663),k=d(2723),M=d(6141),I=d(8461);const $=()=>[1,1,1,1,1,1,1,1];function S(r,l){if(1&r&&(t.j41(0,"span",31),t.nrm(1,"ion-icon",32),t.EFF(2),t.k0s()),2&r){const a=t.XpG(2).$implicit,e=t.XpG(2);t.R7$(2),t.SpI(" ",e.getDisplayInstructions(a)," ")}}function w(r,l){if(1&r&&(t.qex(0),t.j41(1,"span",28),t.nrm(2,"ion-icon",29),t.EFF(3),t.k0s(),t.DNE(4,S,3,1,"span",30),t.bVm()),2&r){const a=t.XpG().$implicit,e=t.XpG(2);t.R7$(3),t.SpI(" ",e.getDisplayAddress(a)||"Entrega a domicilio"," "),t.R7$(),t.Y8G("ngIf",e.getDisplayInstructions(a))}}function L(r,l){1&r&&(t.j41(0,"span",14),t.nrm(1,"ion-icon",33),t.EFF(2," Entrega en negocio "),t.k0s())}function R(r,l){if(1&r){const a=t.RV6();t.j41(0,"ion-item-option",34),t.bIt("click",function(){t.eBV(a);const n=t.XpG().$implicit,i=t.XpG(2);return t.Njj(i.cancelarPedido(n))}),t.nrm(1,"ion-icon",35),t.EFF(2," Cancelar "),t.k0s()}}function G(r,l){if(1&r){const a=t.RV6();t.j41(0,"ion-list")(1,"ion-item-sliding",9)(2,"ion-item",10)(3,"ion-label")(4,"div",11)(5,"h2"),t.nrm(6,"ion-icon",12),t.EFF(7),t.nI1(8,"number"),t.k0s()(),t.j41(9,"div",13)(10,"span",14),t.nrm(11,"ion-icon",15),t.EFF(12),t.k0s(),t.j41(13,"span",16),t.nrm(14,"ion-icon",17),t.EFF(15),t.k0s()(),t.j41(16,"div",13),t.nrm(17,"ion-icon",17),t.EFF(18),t.k0s(),t.j41(19,"div",13)(20,"span",14),t.nrm(21,"ion-icon",18),t.EFF(22),t.nI1(23,"date"),t.k0s()(),t.j41(24,"div",19),t.DNE(25,w,5,2,"ng-container",20)(26,L,3,0,"ng-template",null,0,t.C5r),t.k0s(),t.j41(28,"div",21)(29,"ion-chip",22)(30,"ion-label"),t.EFF(31),t.k0s()(),t.j41(32,"ion-chip",23),t.nrm(33,"ion-icon",24),t.j41(34,"ion-label"),t.EFF(35),t.k0s()()()()(),t.j41(36,"ion-item-options")(37,"ion-item-option",25),t.bIt("click",function(){const n=t.eBV(a).$implicit,i=t.XpG(2);return t.Njj(i.openAsignarEntrega(n))}),t.EFF(38," Entregar "),t.nrm(39,"ion-icon",26),t.k0s(),t.DNE(40,R,3,0,"ion-item-option",27),t.k0s()()()}if(2&r){const a=l.$implicit,e=t.sdS(27),n=t.XpG(2);t.R7$(7),t.SpI(" $",t.i5U(8,17,a.total,"1.2-2")," "),t.R7$(5),t.SpI(" ",a.nombre_cliente," "),t.R7$(2),t.Y8G("color",n.getColorIcon(a.estatus))("name",n.getStatusIcon(a.estatus)),t.R7$(),t.SpI(" ",n.getDisplayStatus(a)," "),t.R7$(2),t.Y8G("color",n.getDeliveryTypeColor(n.getEffectiveDeliveryType(a)))("name",n.getDeliveryTypeIcon(n.getEffectiveDeliveryType(a))),t.R7$(),t.SpI(" ",n.getEffectiveDeliveryType(a)," "),t.R7$(4),t.Lme(" ",n.getScheduledLabel(a),": ",t.i5U(23,20,n.getScheduledDate(a),"dd/MM/yyyy HH:mm")," "),t.R7$(3),t.Y8G("ngIf","domicilio"===n.getEffectiveDeliveryType(a))("ngIfElse",e),t.R7$(6),t.JRh(a.tipo_pago),t.R7$(),t.Y8G("color",n.getDeliveryTypeColor(n.getEffectiveDeliveryType(a))),t.R7$(),t.Y8G("name",n.getDeliveryTypeIcon(n.getEffectiveDeliveryType(a))),t.R7$(2),t.JRh(n.getEffectiveDeliveryType(a)),t.R7$(5),t.Y8G("ngIf","cancelado"!==a.estatus.toLowerCase()&&"entregado"!==a.estatus.toLowerCase())}}function O(r,l){if(1&r&&(t.qex(0),t.DNE(1,G,41,23,"ion-list",8),t.bVm()),2&r){const a=t.XpG();t.R7$(),t.Y8G("ngForOf",a.pedidosFiltrados)}}function j(r,l){1&r&&(t.j41(0,"ion-item",9)(1,"ion-avatar",37),t.nrm(2,"ion-skeleton-text",38),t.k0s(),t.j41(3,"ion-label")(4,"div"),t.nrm(5,"ion-skeleton-text",39),t.k0s(),t.j41(6,"div"),t.nrm(7,"ion-skeleton-text",40),t.k0s()()())}function N(r,l){1&r&&(t.j41(0,"ion-list"),t.DNE(1,j,8,0,"ion-item",36),t.k0s()),2&r&&(t.R7$(),t.Y8G("ngForOf",t.lJ4(1,$)))}function A(r,l){1&r&&(t.j41(0,"div",41),t.nrm(1,"ion-icon",42),t.j41(2,"h3"),t.EFF(3,"No hay pedidos disponibles"),t.k0s()())}const Y=[{path:"",component:(()=>{var r;class l{constructor(e,n){this.modalCtrl=e,this.alertController=n,this.showModal=!1,this.isEditing=!1,this.pedidos=[],this.detalle_pedido=[],this.loading=!1,this.searchTerm="",this.filtersApplied=!1,this.pedidosFiltrados=[],this.utilsSvc=(0,t.WQX)(k.T),this.firebaseSvc=(0,t.WQX)(F.f),this.fecha=(new Date).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}ngOnInit(){this.fecha=this.fecha.charAt(0).toUpperCase()+this.fecha.slice(1),this.getPedidos()}user(){return this.utilsSvc.getFromLocalStorage("user")}doRefresh(e){setTimeout(()=>{this.getPedidos(),e.target.complete()},1e3)}closeModal(){this.showModal=!1}getPedidos(){var e=this;this.loading=!0;const i=this.firebaseSvc.getCollectionData("pedidos",[]).subscribe({next:o=>{if(Array.isArray(o)){console.log("Pedidos obtenidos:",o),this.pedidos=o;const g=this.normalizeText("En espera de recolecci\xf3n"),f=o.filter(s=>{const v=this.normalizeText(null==s?void 0:s.estatus).includes(g),y=this.normalizeText(null==s?void 0:s.tipo_pago).includes("efectivo"),E=this.isTodayDateLike(null==s?void 0:s.fecha_recoger)||this.isTodayDateLike(null==s?void 0:s.fecha_entrega)||this.isTodayDateLike(null==s?void 0:s.fecha);return v&&y&&E});this.pedidos=f;const h=this.pedidos.map(function(){var s=(0,p.A)(function*(u){const v=`users/${u.uid_cliente}`;return yield e.firebaseSvc.getDocument(v).then(m=>{var y,E,P;u.nombre_cliente=`${null!==(y=null==m?void 0:m.name)&&void 0!==y?y:""} ${null!==(E=null==m?void 0:m.mother_Last_Name)&&void 0!==E?E:""} ${null!==(P=null==m?void 0:m.father_Last_Name)&&void 0!==P?P:""}`.trim(),e.firebaseSvc.getCollectionData(`pedidos/${u.id}/detalle_pedido`,[]).subscribe({next:b=>{u.detalle_pedido=b,u.detalle_pedido.forEach(function(){var B=(0,p.A)(function*(D){const V=`productos/${D.uid_producto}`;try{const K=yield e.firebaseSvc.getDocument(V);D.producto=K}catch{}});return function(D){return B.apply(this,arguments)}}())},error:b=>console.error("Error al obtener datos:",b)})}),yield e.ensureAddress(u),u});return function(u){return s.apply(this,arguments)}}());Promise.all(h).then(()=>{this.pedidosFiltrados=this.pedidos,this.loading=!1}).catch(()=>{this.loading=!1})}else this.pedidos=[],this.pedidosFiltrados=[];i.unsubscribe()},error:()=>{this.loading=!1}})}normalizeText(e=""){return String(e||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim()}parseFlexibleDateString(e){if(!e)return null;const n=String(e).trim(),i=new Date(n);if(!isNaN(i.getTime()))return i;const o=n.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);if(!o)return null;const g=parseInt(o[1],10),f=parseInt(o[2],10)-1,h=parseInt(o[3],10),s=o[4]?parseInt(o[4],10):0,u=o[5]?parseInt(o[5],10):0,v=o[6]?parseInt(o[6],10):0,m=new Date(h,f,g,s,u,v,0);return isNaN(m.getTime())?null:m}normalizeDateLike(e){if(!e)return null;if(null!=e&&e.toDate&&"function"==typeof e.toDate){const i=e.toDate();return new Date(i.getFullYear(),i.getMonth(),i.getDate())}if(null!=e&&e.seconds){const i=new Date(1e3*e.seconds);return new Date(i.getFullYear(),i.getMonth(),i.getDate())}if("string"==typeof e){const i=this.parseFlexibleDateString(e);return i?new Date(i.getFullYear(),i.getMonth(),i.getDate()):null}const n=new Date(e);return isNaN(n.getTime())?null:new Date(n.getFullYear(),n.getMonth(),n.getDate())}isTodayDateLike(e){const n=this.normalizeDateLike(e);if(!n)return!1;const i=new Date,o=new Date(i.getFullYear(),i.getMonth(),i.getDate()),g=new Date(o.getTime()+864e5);return n>=o&&n<g}filterPedidos(){const e=this.searchTerm.toLowerCase();this.pedidosFiltrados=this.pedidos.filter(n=>n.nombre_cliente.toLowerCase().includes(e)||n.total.toFixed(2).includes(e)||n.id.toLowerCase().includes(e)||n.estatus.toLowerCase().includes(e))}cancelarPedido(e){var n=this;return(0,p.A)(function*(){var o;yield(yield n.alertController.create({header:"Cancelar Pedido",mode:"ios",message:"\xbfRealmente deseas cancelar el pedido?",cssClass:"custom-alert",buttons:[{text:"Cancelar",role:"cancel",cssClass:"alert-cancel"},{text:"Confirmar",cssClass:"alert-confirm",handler:(o=(0,p.A)(function*(){const g=`pedidos/${e.id}`,f=yield n.utilsSvc.loading();yield f.present(),e.estatus="Cancelado",n.firebaseSvc.updateDocumet(g,{estatus:e.estatus}).finally(()=>{f.dismiss(),n.getPedidos()})}),function(){return o.apply(this,arguments)})}],backdropDismiss:!1})).present()})()}getColorIcon(e){switch(e.toLowerCase()){case"cancelado":return"danger";case"entregado":return"primary";default:return"dark"}}openAsignarEntrega(e){var n=this;return(0,p.A)(function*(){(yield n.utilsSvc.presentModal({component:M.L,componentProps:{pedido:e}}))&&n.utilsSvc.presentToast({message:"Pedido entregado",duration:2500,color:"primary",position:"bottom",icon:"checkmark-circle-outline"}),n.getPedidos()})()}escanear(){this.utilsSvc.routerLink("main/escaner-qr")}getStatusIcon(e){switch((e||"").toLowerCase()){case"pedido confirmado":return"bag-check-outline";case"en preparaci\xf3n":return"refresh-circle-outline";case"en espera de recolecci\xf3n":return"time-outline";case"entregado":return"checkmark-done-outline";case"cancelado":return"close-circle-outline";default:return"help-circle-outline"}}hasUbicacion(e){var n,i;if(!e)return!1;const o=null==e?void 0:e.geopoint_entrega,g=o&&"number"==typeof o.latitude&&"number"==typeof o.longitude&&!isNaN(o.latitude)&&!isNaN(o.longitude),f="number"==typeof(null==e?void 0:e.lat)&&"number"==typeof(null==e?void 0:e.lng)||"number"==typeof(null==e||null===(n=e.coordenadas)||void 0===n?void 0:n.lat)&&"number"==typeof(null==e||null===(i=e.coordenadas)||void 0===i?void 0:i.lng);return!(!g&&!f)}getEffectiveDeliveryType(e){const n=((null==e?void 0:e.tipo_entrega)||"").toLowerCase();return n?"domicilio"===n&&this.hasUbicacion(e)?"domicilio":"negocio":this.hasUbicacion(e)?"domicilio":"negocio"}getDeliveryTypeIcon(e){switch((e||"").toLowerCase()){case"domicilio":return"home-outline";case"negocio":return"storefront-outline";default:return"location-outline"}}getDeliveryTypeColor(e){switch((e||"").toLowerCase()){case"domicilio":return"primary";case"negocio":return"success";default:return"medium"}}getGoogleMapsApiKey(){const e="AIzaSyB5Zq3Y9PdVBkxPkG2FMF69Ti4zA0ZKjEE";try{var n;const o=this.utilsSvc.getFromLocalStorage("google_maps_key")||(null===(n=window)||void 0===n?void 0:n.GOOGLE_MAPS_API_KEY)||e;try{o&&!this.utilsSvc.getFromLocalStorage("google_maps_key")&&localStorage.setItem("google_maps_key",o)}catch{}return o}catch{var i;return(null===(i=window)||void 0===i?void 0:i.GOOGLE_MAPS_API_KEY)||e}}getPedidoLatLng(e){var n,i;if(!e)return null;const o=null==e?void 0:e.geopoint_entrega;return o&&"number"==typeof o.latitude&&"number"==typeof o.longitude?{lat:o.latitude,lng:o.longitude}:"number"==typeof(null==e?void 0:e.lat)&&"number"==typeof(null==e?void 0:e.lng)?{lat:e.lat,lng:e.lng}:"number"==typeof(null==e||null===(n=e.coordenadas)||void 0===n?void 0:n.lat)&&"number"==typeof(null==e||null===(i=e.coordenadas)||void 0===i?void 0:i.lng)?{lat:e.coordenadas.lat,lng:e.coordenadas.lng}:null}ensureAddress(e){var n=this;return(0,p.A)(function*(){var i;if(!e)return;if("domicilio"!==n.getEffectiveDeliveryType(e))return void(e._direccion_texto="Entrega en negocio");const o=e._direccion_texto||e.direccion_texto||e.direccionCompleta||(null===(i=e.direccion)||void 0===i?void 0:i.texto);if(o)return void(e._direccion_texto=o);const g=n.getPedidoLatLng(e);if(!g)return void(e._direccion_texto="Ubicaci\xf3n proporcionada por el cliente");const f=n.getGoogleMapsApiKey();if(f)try{const h=`https://maps.googleapis.com/maps/api/geocode/json?latlng=${g.lat},${g.lng}&key=${encodeURIComponent(f)}&language=es`,s=yield fetch(h);if(console.log("Geocoding response:",s),!s.ok)throw new Error("HTTP error");const u=yield s.json();e._direccion_texto="OK"===u.status&&Array.isArray(u.results)&&u.results.length?u.results[0].formatted_address:"Ubicaci\xf3n proporcionada por el cliente"}catch{e._direccion_texto="Ubicaci\xf3n proporcionada por el cliente"}else e._direccion_texto="Ubicaci\xf3n proporcionada por el cliente"})()}getDisplayAddress(e){var n;if(!e)return"";if(e._direccion_texto)return e._direccion_texto;const i=e.direccion_texto||e.direccionCompleta||(null===(n=e.direccion)||void 0===n?void 0:n.texto)||"";if(i)return i;const o=e.direccion||{},g=[o.calle&&o.numero?`${o.calle} ${o.numero}`:o.calle,o.colonia,o.municipio||o.ciudad,o.estado,o.cp||o.codigo_postal].filter(Boolean);return g.length?g.join(", "):"Ubicaci\xf3n proporcionada por el cliente"}getDisplayInstructions(e){var n;return(null==e?void 0:e.indicaciones)||(null==e?void 0:e.instrucciones)||(null==e||null===(n=e.direccion)||void 0===n?void 0:n.indicaciones)||""}toDateTime(e){if(!e)return null;if(null!=e&&e.toDate&&"function"==typeof e.toDate)return e.toDate();if(null!=e&&e.seconds)return new Date(1e3*e.seconds);const n=new Date(e);return isNaN(n.getTime())?null:n}getScheduledDate(e){var n,i;const o=null!==(n=null!==(i=null==e?void 0:e.fecha_recoger)&&void 0!==i?i:null==e?void 0:e.fecha_entrega)&&void 0!==n?n:null==e?void 0:e.fecha;return this.toDateTime(o)}getScheduledLabel(e){return"domicilio"===(this.getEffectiveDeliveryType(e)||"").toLowerCase()?"Horario de entrega":null!=e&&e.fecha_recoger?"Horario de recolecci\xf3n":null!=e&&e.fecha_entrega?"Horario de entrega":"Horario"}getDisplayStatus(e){const n=e.estatus;return"domicilio"===this.getEffectiveDeliveryType(e)&&this.normalizeText(n).includes(this.normalizeText("En espera de recolecci\xf3n"))?"En proceso de entrega":n}}return(r=l).\u0275fac=function(e){return new(e||r)(t.rXU(c.W3),t.rXU(c.hG))},r.\u0275cmp=t.VBU({type:r,selectors:[["app-entregas"]],decls:11,vars:5,consts:[["enNegocio",""],["title","Entregas",3,"showMenu"],["slot","fixed",3,"ionRefresh"],["mode","ios","animated","true","placeholder","Cliente, productos, precio o c\xf3digo",3,"ngModelChange","ionInput","ngModel"],["expand","block","fill","solid","shape","round","color","primary",1,"modern-btn",3,"click"],["slot","start","name","qr-code-outline",1,"icono"],[4,"ngIf"],["class","empty",4,"ngIf"],[4,"ngFor","ngForOf"],[1,"product-item"],[1,"card"],[1,"name"],["slot","start","color","danger","name","cash-outline",1,"mr-8"],[1,"data"],[1,"muted"],["slot","start","name","person-outline"],[1,"status"],["slot","start",3,"color","name"],["slot","start","name","time-outline"],[1,"data","vertical"],[4,"ngIf","ngIfElse"],[1,"data","chips-bottom"],["color","primary","mode","ios","outline","true"],["mode","ios","outline","true",3,"color"],[3,"name"],["color","dark",3,"click"],["name","archive-outline",1,"ml-8"],["color","danger",3,"click",4,"ngIf"],[1,"muted","truncate-2"],["slot","start","name","location-outline"],["class","instructions truncate-2",4,"ngIf"],[1,"instructions","truncate-2"],["name","information-circle-outline"],["slot","start","name","storefront-outline"],["color","danger",3,"click"],["name","close-circle-outline",1,"option-btn",2,"margin-right","0.5rem"],["class","product-item",4,"ngFor","ngForOf"],["slot","start"],["animated","",2,"width","100%","height","100%"],["animated","",2,"width","50%"],["animated","",2,"width","30%"],[1,"empty"],["name","shield-outline"]],template:function(e,n){1&e&&(t.nrm(0,"app-header",1),t.j41(1,"ion-content")(2,"ion-refresher",2),t.bIt("ionRefresh",function(o){return n.doRefresh(o)}),t.nrm(3,"ion-refresher-content"),t.k0s(),t.j41(4,"ion-searchbar",3),t.mxI("ngModelChange",function(o){return t.DH7(n.searchTerm,o)||(n.searchTerm=o),o}),t.bIt("ionInput",function(){return n.filterPedidos()}),t.k0s(),t.j41(5,"ion-button",4),t.bIt("click",function(){return n.escanear()}),t.nrm(6,"ion-icon",5),t.EFF(7," Escanear QR "),t.k0s(),t.DNE(8,O,2,1,"ng-container",6)(9,N,2,2,"ion-list",6)(10,A,4,0,"div",7),t.k0s()),2&e&&(t.Y8G("showMenu",!0),t.R7$(4),t.R50("ngModel",n.searchTerm),t.R7$(4),t.Y8G("ngIf",n.pedidosFiltrados.length>0),t.R7$(),t.Y8G("ngIf",n.loading),t.R7$(),t.Y8G("ngIf",!n.loading&&!n.pedidosFiltrados.length))},dependencies:[_.Sq,_.bT,x.BC,x.vS,c.mC,c.Jm,c.ZB,c.W9,c.iq,c.uz,c.LU,c.CE,c.A7,c.he,c.nf,c.To,c.Ki,c.S1,c.ds,c.Gw,I.l,_.QX,_.vh],styles:['@charset "UTF-8";.custom-btn[_ngcontent-%COMP%]{--border-radius: 25px;--padding-start: 20px;--padding-end: 20px;--padding-top: 12px;--padding-bottom: 12px;--box-shadow: 0px 4px 6px rgba(0, 0, 0, .1);--background: linear-gradient(45deg, #1ad436, #1abf7e);--color: white;font-size:16px;font-weight:700}.icono[_ngcontent-%COMP%]{font-size:22px;margin-right:8px}.option-btn[_ngcontent-%COMP%]{margin-left:.5rem}.name[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{display:flex;align-items:center;margin:0 0 6px}.data[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;margin:6px 0;flex-wrap:wrap}.data.vertical[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.35rem}.data[_ngcontent-%COMP%]   .status[_ngcontent-%COMP%]{margin-left:1.5rem}.status[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.35rem;font-weight:600}.muted[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.35rem;color:#616161}.instructions[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.35rem;color:#555;line-height:1.3}.empty[_ngcontent-%COMP%]{padding:2rem 1rem;text-align:center;color:#7d7d7d}.empty[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:3rem;margin-bottom:.5rem}.truncate-2[_ngcontent-%COMP%]{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.card[_ngcontent-%COMP%]{--inner-padding-top: 10px;--inner-padding-bottom: 10px;--inner-padding-start: 12px;--inner-padding-end: 12px;border-radius:12px;background:var(--ion-color-light, #f7f7f7);margin:8px 0}.mr-8[_ngcontent-%COMP%]{margin-right:8px}.ml-8[_ngcontent-%COMP%]{margin-left:8px}.chips-bottom[_ngcontent-%COMP%]{margin-top:8px;display:flex;gap:.5rem;flex-wrap:wrap}@media (max-width: 480px){.data[_ngcontent-%COMP%]{gap:.5rem}.data[_ngcontent-%COMP%]   .status[_ngcontent-%COMP%]{margin-left:0}.status[_ngcontent-%COMP%]{font-weight:500}}']}),l})()}];let U=(()=>{var r;class l{}return(r=l).\u0275fac=function(e){return new(e||r)},r.\u0275mod=t.$C({type:r}),r.\u0275inj=t.G2t({imports:[T.iI.forChild(Y),T.iI]}),l})();var z=d(7383);let X=(()=>{var r;class l{}return(r=l).\u0275fac=function(e){return new(e||r)},r.\u0275mod=t.$C({type:r}),r.\u0275inj=t.G2t({imports:[_.MD,x.YN,c.bv,U,z.G]}),l})()}}]);