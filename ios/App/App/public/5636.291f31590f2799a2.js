"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5636],{5636:(L,g,l)=>{l.r(g),l.d(g,{ProfilePageModule:()=>O});var m=l(177),y=l(9417),u=l(5933),h=l(8265),d=l(467),e=l(4438),v=l(7517),F=l(2723),S=l(3405),P=l(7762),C=l(3125),_=l(2784),I=l(6354);let k=(()=>{var t;class a{constructor(){this.firebaseSvc=(0,e.WQX)(v.f)}sendCoupon(i){var o=this;return(0,d.A)(function*(){return o.firebaseSvc.addDocument("cupones",{...i,usado:!1,creado:(0,_.O5)()})})()}getActiveCoupons(i){const o=new Date;return this.firebaseSvc.getCollectionData("cupones",[(0,_._M)("uid","==",i)]).pipe((0,I.T)(r=>{const c=s=>null!=s&&s.toDate?s.toDate():new Date(s);return r.filter(s=>s&&!1===s.usado&&c(s.expira)>=o).sort((s,p)=>c(s.expira).getTime()-c(p.expira).getTime())}))}markUsed(i){var o=this;return(0,d.A)(function*(){return o.firebaseSvc.updateDocumet(`cupones/${i}`,{usado:!0})})()}}return(t=a).\u0275fac=function(i){return new(i||t)},t.\u0275prov=e.jDH({token:t,factory:t.\u0275fac,providedIn:"root"}),a})();var b=l(8461);function D(t,a){if(1&t&&e.nrm(0,"img",16),2&t){let n;const i=e.XpG();e.Y8G("src",null==(n=i.user())?null:n.image,e.B4B)}}function T(t,a){1&t&&e.nrm(0,"ion-icon",17)}function E(t,a){if(1&t&&(e.j41(0,"ion-badge",18),e.EFF(1),e.k0s()),2&t){const n=e.XpG();e.R7$(),e.JRh(n.notificationCount)}}function M(t,a){if(1&t&&(e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3),e.k0s(),e.j41(4,"ion-card-subtitle"),e.EFF(5),e.k0s()(),e.j41(6,"ion-card-content",22),e.EFF(7),e.nrm(8,"br"),e.EFF(9),e.nrm(10,"br"),e.EFF(11),e.nI1(12,"date"),e.k0s()()),2&t){const n=a.$implicit;e.R7$(3),e.JRh(n.descripcion),e.R7$(2),e.Lme("C\xf3digo: ",n.codigo," \u2022 ",n.porcentaje,"% de descuento"),e.R7$(2),e.SpI(" - Compra m\xednima: $",n.minimo_compra,""),e.R7$(2),e.SpI(" - Requiere al menos ",n.numero_compras," compras acumuladas"),e.R7$(2),e.SpI(" - Expira: ",e.i5U(12,6,n.expira,"dd/MM/yyyy")," ")}}function R(t,a){if(1&t&&(e.qex(0),e.DNE(1,M,13,9,"ion-card",21),e.bVm()),2&t){const n=e.XpG(2);e.R7$(),e.Y8G("ngForOf",n.coupons)("ngForTrackBy",n.trackByCouponId)}}function j(t,a){1&t&&(e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3,"Sin notificaciones"),e.k0s(),e.j41(4,"ion-card-subtitle"),e.EFF(5,"No tienes cupones activos por ahora"),e.k0s()(),e.j41(6,"ion-card-content",22),e.EFF(7," Cuando recibas un cup\xf3n, aparecer\xe1 aqu\xed con su fecha de expiraci\xf3n y condiciones. "),e.k0s()())}function $(t,a){if(1&t&&(e.j41(0,"div",19),e.DNE(1,R,2,2,"ng-container",20)(2,j,8,0,"ng-template",null,0,e.C5r),e.k0s()),2&t){const n=e.sdS(3),i=e.XpG();e.R7$(),e.Y8G("ngIf",null==i.coupons?null:i.coupons.length)("ngIfElse",n)}}function x(t,a){1&t&&e.nrm(0,"ion-icon",23)}const N=[{path:"",component:(()=>{var t;class a{constructor(){this.firebaseSvc=(0,e.WQX)(v.f),this.utilsSvc=(0,e.WQX)(F.T),this.modalCtrl=(0,e.WQX)(u.W3),this.couponSvc=(0,e.WQX)(k),this.isDireccionVacia=!1,this.coupons=[],this.notificationCount=0,this.showNotifications=!1,this.staticNotifications=[]}ngOnInit(){var i=this;return(0,d.A)(function*(){"granted"!==(yield P.L.checkPermissions()).location&&"granted"!==(yield P.L.requestPermissions()).location||(i.isDireccionVacia=i.checkIfDireccionIsEmpty(),1==i.user().type_profile?i.tipo_perfil="Super administrador":2==i.user().type_profile?i.tipo_perfil="Administrador":3==i.user().type_profile&&(i.tipo_perfil="Usuario"),i.subscribeCoupons())})()}user(){return this.utilsSvc.getFromLocalStorage("user")}dir(){return this.utilsSvc.getFromLocalStorage("direccion")||{}}checkIfDireccionIsEmpty(){const i=this.dir();return!i||0===Object.keys(i).length}doRefresh(i){setTimeout(()=>{this.user(),this.dir(),this.isDireccionVacia=this.checkIfDireccionIsEmpty(),i.target.complete()},1e3)}takeImage(){var i=this;return(0,d.A)(function*(){let o=i.user(),r=`users/${o.uid}`;const c=(yield i.utilsSvc.takePicture("Imagen de perfil")).dataUrl,s=yield i.utilsSvc.loading();yield s.present();let p=`/users/${o.uid}`;o.image=yield i.firebaseSvc.uploadImage(p,c),i.firebaseSvc.updateDocumet(r,{image:o.image}).then(function(){var f=(0,d.A)(function*(Y){i.utilsSvc.saveInLocalStorage("user",o),i.utilsSvc.presentToast({message:"Imagen actualizada correctamente",duration:1500,color:"success",position:"middle",icon:"checkmark-circle-outline"})});return function(Y){return f.apply(this,arguments)}}()).catch(f=>{i.utilsSvc.presentToast({message:f.message,duration:2500,color:"primary",position:"middle",icon:"alert-circle-outline"})}).finally(()=>{s.dismiss()})})()}direccion(){var i=this;return(0,d.A)(function*(){i.utilsSvc.presentToast({message:"Pulsa el marcador y arr\xe1stralo hasta tu ubicaci\xf3n exacta",duration:3500,color:"tertiary",position:"bottom",icon:"navigate-circle-outline"}),1==i.user().type_profile?i.utilsSvc.routerLink("main/direccion-superadmin"):i.utilsSvc.routerLink("main/direccion")})()}terms(){var i=this;return(0,d.A)(function*(){yield i.utilsSvc.presentModal({component:S.TermsComponent,cssClass:"app-terms",componentProps:{}})})()}actualizarPerfilmodal(){var i=this;return(0,d.A)(function*(){(yield i.utilsSvc.presentModal({component:C.A,componentProps:{userForm:i.user()}}))&&i.reloadUserFromFirebase()})()}reloadUserFromFirebase(){var i=this;return(0,d.A)(function*(){const o=i.user();try{const r=yield i.firebaseSvc.getDocument(`users/${o.uid}`);r&&(i.utilsSvc.saveInLocalStorage("user",r),i.utilsSvc.presentToast({message:"Perfil actualizado correctamente.",duration:1500,color:"success",position:"middle",icon:"checkmark-circle-outline"}))}catch{i.utilsSvc.presentToast({message:"Error al recargar el perfil.",duration:2e3,color:"danger",position:"middle"})}})()}subscribeCoupons(){var i;const o=null===(i=this.user())||void 0===i?void 0:i.uid;o&&this.couponSvc.getActiveCoupons(o).subscribe(r=>{this.coupons=r.map(c=>{var s;return{...c,expira:null!=c&&null!==(s=c.expira)&&void 0!==s&&s.toDate?c.expira.toDate():c.expira}}),this.notificationCount=this.coupons.length})}toggleNotifications(){this.showNotifications=!this.showNotifications,this.showNotifications&&0===this.notificationCount&&this.utilsSvc.presentToast({message:"No tienes notificaciones por ahora.",duration:1800,color:"medium",position:"middle",icon:"notifications-off-outline"})}trackByCouponId(i,o){return(null==o?void 0:o.id)||(null==o?void 0:o.codigo)||i}trackByStaticNotif(i,o){return(null==o?void 0:o.title)||i}sendDemoCoupon(){var i=this;return(0,d.A)(function*(){const o=i.user();if(null==o||!o.uid)return;const r=s=>{const p=new Date;return p.setDate(p.getDate()+s),p.setHours(23,59,59,999),p},c=`DEMO${Math.floor(1e3+9e3*Math.random())}`;try{yield i.couponSvc.sendCoupon({uid:o.uid,codigo:c,descripcion:"Cup\xf3n de ejemplo: descuento en tu pr\xf3xima compra",porcentaje:20,numero_compras:1,minimo_compra:100,expira:r(7)}),i.utilsSvc.presentToast({message:`Cup\xf3n ${c} enviado`,duration:2e3,color:"success",position:"middle",icon:"gift-outline"}),i.showNotifications=!0}catch{i.utilsSvc.presentToast({message:"No se pudo enviar el cup\xf3n",duration:2e3,color:"danger",position:"middle",icon:"alert-circle-outline"})}})()}buildStaticNotifications(){const i=new Date;i.setDate(i.getDate()+14),this.staticNotifications=[{title:"Cup\xf3n de bienvenida",message:"Tienes un cup\xf3n del 15% en tu siguiente compra. M\xednimo $150.",icon:"pricetags-outline",date:i}],this.notificationCount=this.coupons.length+this.staticNotifications.length}}return(t=a).\u0275fac=function(i){return new(i||t)},t.\u0275cmp=e.VBU({type:t,selectors:[["app-profile"]],decls:32,vars:8,consts:[["emptyCoupons",""],["title","Mi perfil",3,"showMenu"],[1,"ion-padding-top","ion-text-center"],["slot","fixed",3,"ionRefresh"],[3,"src",4,"ngIf"],["class","empty-icon","name","person-circle-outline",4,"ngIf"],["mode","ios","size","small","shape","round",1,"photo-btn",3,"click"],["name","camera-outline"],["button","","detail","",3,"click"],["color","primary","slot","start","name","person-outline"],["color","primary","slot","start","name","notifications-outline"],["slot","end","color","danger",4,"ngIf"],["class","coupon-list ion-padding-start ion-padding-end",4,"ngIf"],["color","primary","slot","start","name","navigate-outline"],["name","alert-circle-outline","color","danger",4,"ngIf"],["color","primary","slot","start","name","document-outline"],[3,"src"],["name","person-circle-outline",1,"empty-icon"],["slot","end","color","danger"],[1,"coupon-list","ion-padding-start","ion-padding-end"],[4,"ngIf","ngIfElse"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"ion-text-start"],["name","alert-circle-outline","color","danger"]],template:function(i,o){if(1&i&&(e.nrm(0,"app-header",1),e.j41(1,"ion-content",2)(2,"ion-refresher",3),e.bIt("ionRefresh",function(c){return o.doRefresh(c)}),e.nrm(3,"ion-refresher-content"),e.k0s(),e.j41(4,"ion-avatar"),e.DNE(5,D,1,1,"img",4)(6,T,1,0,"ion-icon",5),e.k0s(),e.j41(7,"ion-button",6),e.bIt("click",function(){return o.takeImage()}),e.nrm(8,"ion-icon",7),e.k0s(),e.j41(9,"h2"),e.EFF(10),e.k0s(),e.j41(11,"div"),e.EFF(12),e.k0s(),e.j41(13,"ion-item",8),e.bIt("click",function(){return o.actualizarPerfilmodal()}),e.nrm(14,"ion-icon",9),e.j41(15,"ion-label"),e.EFF(16,"Editar Perfil"),e.k0s()(),e.j41(17,"ion-item",8),e.bIt("click",function(){return o.toggleNotifications()}),e.nrm(18,"ion-icon",10),e.j41(19,"ion-label"),e.EFF(20,"Notificaciones"),e.k0s(),e.DNE(21,E,2,1,"ion-badge",11),e.k0s(),e.DNE(22,$,4,2,"div",12),e.j41(23,"ion-item",8),e.bIt("click",function(){return o.direccion()}),e.nrm(24,"ion-icon",13),e.j41(25,"ion-label"),e.EFF(26,"Mi direcci\xf3n "),e.DNE(27,x,1,0,"ion-icon",14),e.k0s()(),e.j41(28,"ion-item",8),e.bIt("click",function(){return o.terms()}),e.nrm(29,"ion-icon",15),e.j41(30,"ion-label"),e.EFF(31,"T\xe9rminos y Condiciones"),e.k0s()()()),2&i){let r,c;e.Y8G("showMenu",!0),e.R7$(5),e.Y8G("ngIf",null==(r=o.user())?null:r.image),e.R7$(),e.Y8G("ngIf",!(null!=(c=o.user())&&c.image)),e.R7$(4),e.JRh(o.user().name),e.R7$(2),e.JRh(o.tipo_perfil),e.R7$(9),e.Y8G("ngIf",o.notificationCount),e.R7$(),e.Y8G("ngIf",o.showNotifications),e.R7$(5),e.Y8G("ngIf",o.isDireccionVacia)}},dependencies:[m.Sq,m.bT,u.mC,u.In,u.Jm,u.b_,u.I9,u.ME,u.HW,u.tN,u.W9,u.iq,u.uz,u.he,u.To,u.Ki,b.l,m.vh],styles:["ion-avatar[_ngcontent-%COMP%]{width:140px;height:140px;margin:0 auto}.photo-btn[_ngcontent-%COMP%]{position:relative;bottom:25px}h2[_ngcontent-%COMP%]{margin-bottom:0;font-weight:bolder}ion-item[_ngcontent-%COMP%]{--padding-top: 15px}.empty-icon[_ngcontent-%COMP%]{font-size:140px;opacity:30%}.coupon-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]{margin:12px 0}"]}),a})()}];let G=(()=>{var t;class a{}return(t=a).\u0275fac=function(i){return new(i||t)},t.\u0275mod=e.$C({type:t}),t.\u0275inj=e.G2t({imports:[h.iI.forChild(N),h.iI]}),a})();var A=l(7383);let O=(()=>{var t;class a{}return(t=a).\u0275fac=function(i){return new(i||t)},t.\u0275mod=e.$C({type:t}),t.\u0275inj=e.G2t({imports:[m.MD,y.YN,u.bv,G,A.G]}),a})()}}]);